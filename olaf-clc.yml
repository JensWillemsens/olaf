# Values to change
# <PASSWORD_HASH>
# <CLOUDFLARE_TOKEN>
# <VPS_BACKUP_USER>

passwd:
  users:
    - name: jens
      password_hash: "<PASSWORD_HASH>"
      home_dir: "/home/jens"
      no_create_home: false
      groups: ["wheel", "docker", "systemd-journal"]
      no_user_group: false

networkd:
  units:
    - name: 10-lan0.link
      contents: |
        [Match]
        MACAddress=40:8d:5c:a4:55:ae

        [Link]
        Description=LAN
        MACAddressPolicy=persistent
        Name=lan0

    - name: 10-wan0.link
      contents: |
        [Match]
        MACAddress=40:8d:5c:a4:55:ad

        [Link]
        Description=WAN
        MACAddressPolicy=persistent
        Name=wan0

    - name: 20-static-lan.network
      contents: |
        [Match]
        Name=lan0

        [Network]
        DNS=84.200.69.80
        DNS=84.200.70.40

        [Address]
        Address=192.168.1.250

        [Route]
        Gateway=192.168.1.1
        # Destination=192.168.1.0/24

    - name: 20-dhcp-wan.network
      contents: |
        [Match]
        Name=wan0

        [Network]
        # DHCP=yes
        DHCP = no

update:
  group: "stable"

locksmith:
  reboot_strategy: "reboot"
  window_start: "Sun 2:00"
  window_length: "2h"

systemd:
  units:
    - name: nextcloud-cron.service
      contents: |
        [Unit]
        Description=Nextcloud cron.php job

        [Service]
        ExecStart=/usr/bin/docker exec --user www-data nextcloud php -f cron.php

        [Install]
        WantedBy=basic.target

    - name: nextcloud-cron.timer
      contents: |
        [Unit]
        Description=Run Nextcloud cron.php every 5 minutes

        [Timer]
        OnBootSec=5min
        OnUnitActiveSec=5min
        Unit=nextcloud-cron.service

        [Install]
        WantedBy=timers.target

    - name: cloudflare-dyndns.service
      contents: |
        [Unit]
        Description=Unit Fail Mailer Service
        After=network.target

        [Service]
        Type=simple
        ExecStart=/opt/bin/systemd-mailjet %I
        EnvironmentFile=/opt/conf/systemd-mailjet.conf
        User=systemd-mailjet

    - name: cloudflare-dyndns.service
      contents: |
        [Unit]
        Description=Update CloudFlare DynDNS
        OnFailure=unit-fail-mail@%n.service

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/docker pull ellerbrock/alpine-cloudflare-dyndns
        ExecStart=/usr/bin/docker run --name dyndns --rm -e CF_EMAIL=acc.cloudflare@jensw.be -e CF_TOKEN=<CLOUDFLARE_TOKEN> -e CF_ZONE_NAME=jensw.eu -e CF_DOMAIN_NAME=jensw.eu ellerbrock/alpine-cloudflare-dyndns

    - name: cloudflare-dyndns.timer
      enable: true
      contents: |
        [Unit]
        Description=Send IP update every 20 mins

        [Timer]
        OnCalendar=*:0/20

        [Install]
        WantedBy=multi-user.target

    - name: btrfs-snapshot.service
      contents: |
        [Unit]
        Description=Check for BTRFS snapshot every hour
        OnFailure=unit-fail-mail@%n.service

        [Service]
        Type=oneshot
        ExecStart=/opt/bin/btrfs-snapshot

    - name: btrfs-snapshot.timer
      enable: true
      contents: |
        [Unit]
        Description=Check for BTRFS snapshot every hour

        [Timer]
        OnCalendar=hourly

        [Install]
        WantedBy=multi-user.target

    - name: backup-nextcloud.service
      contents: |
        [Unit]
        Description=Backup Nextcloud every night
        OnFailure=unit-fail-mail@%n.service

        [Service]
        Type=simple
        ExecStart=/opt/bin/backup-nextcloud

    - name: backup-nextcloud.timer
      enable: true
      contents: |
        [Unit]
        Description=Backup Nextcloud every night

        [Timer]
        OnCalendar=*-*-* 04:00:00
        Persistent=true

        [Install]
        WantedBy=multi-user.target

    - name: backup-vps.service
      contents: |
        [Unit]
        Description=Backup VPS every night
        OnFailure=unit-fail-mail@%n.service

        [Service]
        Type=simple
        ExecStart=/opt/bin/backup-vps
        User=<VPS_BACKUP_USER>

    - name: backup-vps.timer
      enable: true
      contents: |
        [Unit]
        Description=Backup VPS every night

        [Timer]
        OnCalendar=*-*-* 03:00:00
        Persistent=true

        [Install]
        WantedBy=multi-user.target

    - name: btrfs-scrub.service
      contents: |
        [Unit]
        Description=Scrub BTRFS data drives
        OnFailure=unit-fail-mail@%n.service

        [Service]
        Type=simple
        ExecStart=/usr/sbin/btrfs scrub start -Bd /media/data

    - name: btrfs-scrub.timer
      enable: true
      contents: |
        [Unit]
        Description=Scrub BTRFS data drives every 1st of the month

        [Timer]
        OnCalendar=*-*-01 05:00:00
        Persistent=true

        [Install]
        WantedBy=multi-user.target

    - name: media-data.mount
      enable: true
      contents: |
        [Mount]
        What=/dev/disk/by-uuid/c44fbbe8-f708-4bbd-9dfc-8a0fa15fc956
        Where=/media/data
        Type=btrfs
        Options=subvol=main

        [Install]
        WantedBy=multi-user.target

    - name: media-backup.mount
      enable: true
      contents: |
        [Mount]
        What=/dev/disk/by-uuid/c44fbbe8-f708-4bbd-9dfc-8a0fa15fc956
        Where=/media/backup
        Type=btrfs
        Options=subvol=backup

        [Install]
        WantedBy=multi-user.target
