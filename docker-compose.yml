version: '3.7'

x-labels:
  &traefik-tls
  traefik.enable: true
  traefik.http.routers.torrent.entrypoints: websecure
  traefik.http.routers.torrent.tls.certresolver: le-on-cf

services:
#########################
#         PROXY         #
#########################
  traefik:
    image: traefik:latest
    container_name: traefik    
    restart: always
    command:
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.le-on-cf.acme.tlsChallenge=true"
      - "--certificatesresolvers.le-on-cf.acme.email=${ADMIN_MAIL}"
      - "--certificatesresolvers.le-on-cf.acme.storage=/letsencrypt/acme.json"
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"
      - "traefik.http.routers.https-redirect.entrypoints=web"
      - "traefik.http.routers.https-redirect.rule=HostRegexp(`{any:.*}`)"
      - "traefik.http.routers.https-redirect.middlewares=https-redirect"
    ports:
      - 80:80
      - 443:443
    networks:
      - frontend-torrent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-cert:/letsencrypt/ 
    environment:
      - "TZ=${DEFAULT_TIMEZONE}"

#########################
#    Cloudflare DDNS    #
#########################
  cloudflare-ddns:
    image: oznu/cloudflare-ddns
    container_name: cloudflare-ddns
    restart: always
    environment:
      - EMAIL=${CF_API_EMAIL}
      - API_KEY=${CF_API_KEY}
      - ZONE=${CF_ZONE}
      - SUBDOMAIN=${CF_SUBDOMAIN}

#########################
#      AUTO-UPDATER     #
#########################
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --schedule "0 0 4 * * *" --cleanup
    environment:
      - "TZ=${DEFAULT_TIMEZONE}"
      - "WATCHTOWER_NOTIFICATIONS=email"
      - "WATCHTOWER_NOTIFICATION_EMAIL_FROM=host.${HOSTNAME}@${DEFAULT_DOMAIN}"
      - "WATCHTOWER_NOTIFICATION_EMAIL_TO=${ADMIN_MAIL}"
      - "WATCHTOWER_NOTIFICATION_EMAIL_SERVER=${MS_HOST}"
      - "WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=587"
      - "WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=${MS_USER}"
      - "WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=${MS_PW}"
      - "WATCHTOWER_NOTIFICATION_EMAIL_DELAY=60"

#########################
#       TORRENT         #
#########################
  torrent:
    image: linuxserver/deluge
    container_name: torrent
    restart: always
    networks:
      - frontend-torrent
    ports:
      - "58946:58946"
    volumes:
      - "/media/data/services/torrent/:/running"
      - "/media/data/media/000. Plex/Nazien:/downloads"
      - "${PATH_APPDATA}/torrent:/config"
    environment:
      - "TZ=${DEFAULT_TIMEZONE}"
      - PUID=233
      - PGID=233
    labels:
      << : *traefik-tls
      traefik.docker.network: frontend-torrent
      traefik.http.routers.torrent.rule: Host(`torrent.${DEFAULT_DOMAIN}`)
      traefik.http.services.torrent.loadbalancer.server.port: 8112

#########################
#        SAMBA          #
#########################
  samba:
    image: dperson/samba
    container_name: samba
    restart: always
    networks:
      - samba
    ports:
      - "${LOCAL_IP}:139:139"
      - "${LOCAL_IP}:445:445"
    volumes:
      - /media/data/media:/mnt/media
    environment:
      - "TZ=${DEFAULT_TIMEZONE}"
      - USERID=233
      - GROUPID=233
    command: samba.sh -S -u "nas;${SAMBA_PW_NAS}" -u "scanner;${SAMBA_PW_SCANNER}" -s "media;/mnt/media;yes;no;no;nas" -s "scans;/mnt/media/Scans;yes;no;no;scanner"

#########################
#         PLEX          #
#########################
  plex:
    image: plexinc/pms-docker
    container_name: plex
    restart: always
    network_mode: "host"
    volumes:
      - "/media/data/media/000. Plex:/data/media"
      - /media/data/media-plex-optimized/:/data/optimized
      - "${PATH_APPDATA}/plex/config:/config"
      - "${PATH_APPDATA}/plex/transcode:/transcode"
    environment:
      - "TZ=${DEFAULT_TIMEZONE}"
      - PLEX_CLAIM=${PLEX_CLAIM}
      - PLEX_UID=233
      - PLEX_GID=233
      - ADVERTISE_IP=${PLEX_IP}

#########################
#        BACKUP         #
#########################
  borgmatic:
    image: b3vis/borgmatic
    container_name: borgmatic
    restart: always
    volumes:
      # Backup locations
      - "/media/data/media/000. Plex/Photos:/mnt/source/plex/photos:ro"
      # Config and cache
      - ./conf/borgmatic/borgmatic.d:/etc/borgmatic.d
      - ./conf/borgmatic/ssh:/root/.ssh
      - "${PATH_APPDATA}/borgmatic/config:/root/.config/borg"
      - "${PATH_APPDATA}/borgmatic/cache:/root/.cache/borg"
      - "${PATH_APPDATA}/borgmatic/restore:/mnt/restore"
    environment:
      - "TZ=${DEFAULT_TIMEZONE}"

#########################
#        GENERAL        #
#########################
volumes:
  traefik-cert:

networks:
  frontend-torrent:
    name: frontend-torrent

  samba:
    name: samba

